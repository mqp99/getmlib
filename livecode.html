<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Live Cove with MLib</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" href="https://mqp99.github.io/mlib/sass/mlib.min.css">
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.2.0/css/all.css">
	<link rel="stylesheet" href="livecode/sass/codemirror.css">
	<link rel="stylesheet" href="livecode/sass/ayu-mirage.css">
	<link rel="stylesheet" href="livecode/sass/livecode.css">
</head>
<body>
	<div class="container">
		<div class="container-box">
			<div class="toggle">
				<label>HTML</label>
				<div>
					<span class="setting-html-toggle"><i class="fal fa-chevron-down"></i></span>
				</div>
			</div>
			<textarea class="innerBox innerHTML" placeholder="HTML here..."></textarea>
			<div class="toggle">
				<label>CSS</label>
				<div>
					<span class="setting-toggle"><i class="fal fa-chevron-down"></i></span>
				</div>
			</div>
			<textarea class="innerBox innerCSS" placeholder="CSS here..."></textarea>
		</div>
		<div class="innerBoxPreview">
			<iframe frameborder="0" id="liveUpdate">
				<!DOCTYPE html>
				<html>
					<head lang="vi">
						<meta charset="utf=8">
						<style></style>
					</head>
					<body>
						<h1>222</h1>
					</body>
				</html>
			</iframe>
		</div>
		<div class="setting html">
			<div class="settingCSS">
				<div class="header-setting">
					<span class="header-setting--title">Live Setting</span>
					<span class="header-setting--close setting-close"><i class="fal fa-times"></i></span>
				</div>
				<div class="body-setting">
					<div class="body-setting--left">
						<a href="#" class="setting-link active">HTML</a>
						<a href="#" class="setting-link setting-toggle">CSS</a>
					</div>
					<div class="body-setting--right">
						<p>Chưa có gì để Setting</p>
					</div>
				</div>
			</div>
		</div>
		<div class="setting css">
			<div class="settingCSS">
				<div class="header-setting">
					<span class="header-setting--title">Live Setting</span>
					<span class="header-setting--close setting-close"><i class="fal fa-times"></i></span>
				</div>
				<div class="body-setting">
					<div class="body-setting--left">
						<a href="#" class="setting-link setting-html-toggle">HTML</a>
						<a href="#" class="setting-link active">CSS</a>
					</div>
					<div class="body-setting--right">
						<div class="component">
							<div class="component-title">Thêm liên kết</div>
							<div class="form-group">
								<input type="text" class="form-input focus-green addLinkStyle" placeholder="Nhập liên kết CSS CDN mà bạn muốn !">
								<button class="btn btn-green btn-sm btn-block btn-addLinkStyle">Thêm</button>
							</div>
						</div>
						<div class="component renderLink">
							<div class="component-title">Liên kết đã nhúng</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="auto-save"></div>
	</div>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="livecode/js/codemirror.js"></script>
	<script src="livecode/js/javascript.js"></script>
	<script src="livecode/js/htmlmixed.js"></script>
	<script src="livecode/js/css.js"></script>
	<script>
		var codeHTML = $('.innerHTML')[0];
		var editor = CodeMirror.fromTextArea(codeHTML, {
    		lineNumbers: true,
		    tabSize:5,
		    theme: 'ayu-mirage',
    		name: "text/html",
    		lineWrapping: true,
		});
		var codeCSS = $('.innerCSS')[0];
		var editorCSS = CodeMirror.fromTextArea(codeCSS, {
    		lineNumbers: true,
		    tabSize:5,
		    theme: 'ayu-mirage',
		    mode: "text/css",
    		lineWrapping: true,
		});
	</script>
	<script>
		$(function () {
			/* 
				+ ADD LINK CSS
			*/
				$('.addLinkStyle').keyup(function(){
					_this = $(this).val();
					$('.addLinkStyle').removeClass('error')
					if($.trim(_this) != '') {
						$('.btn-addLinkStyle').fadeIn(100);
					}else{
						$('.btn-addLinkStyle').fadeOut(100);
					}
				})
				$('.setting-html-toggle').click(function(){
					$('.setting.html').addClass('active');
					$('.setting.css').removeClass('active');
				})
				$('.setting-toggle').click(function(){
					$('.setting.html').removeClass('active');
					$('.setting.css').addClass('active');
				})
				$('.setting-close').click(function(){
					$('.setting, .setting.html').removeClass('active');
				})
				/*$(document).on('click','.remove-attr-link',function(){
					var _dataHref = $(this).attr('data-href');
					var getAttrStyle = JSON.parse(localStorage.getItem('setAttrStyle'));
					function checkValue(checkValue) { return valueCheck = (checkValue == _dataHref); }
					getAttrStyle.hrefs.split(',').find(checkValue);
					if(valueCheck == true){
						localStorage.setItem('setAttrStyle',JSON.stringify(
							{ 'hrefs': getAttrStyle.hrefs = ''}
						));
					}
					console.log('s')
				})*/
				$('.btn-addLinkStyle').click(function(){
					var checkUrl = /(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/;
					var _valueThis = $('.addLinkStyle').val().trim();
					if ( checkUrl.test(_valueThis) ){
						var getAttrStyle = JSON.parse(localStorage.getItem('setAttrStyle'));
						if(getAttrStyle.hrefs == ''){
							localStorage.setItem('setAttrStyle',JSON.stringify(
								{ 'hrefs': getAttrStyle.hrefs = `${_valueThis}`}
							));
						}else{
							function checkValue(checkValue) { return valueCheck = (checkValue == _valueThis); }
							getAttrStyle.hrefs.split(',').find(checkValue);
							if(valueCheck == false){
								$('.addLinkStyle').val('');
								appendLink(_valueThis);
								localStorage.setItem('setAttrStyle',JSON.stringify(
									{ 'hrefs': getAttrStyle.hrefs += `,${_valueThis}`}
								));
							}
						}
					    $('.addLinkStyle').removeClass('error')
					}else{
						$('.addLinkStyle').addClass('error')
					}
				})
			/* 
				+ END ADD LINK CSS
			*/
			if(localStorage.getItem("renderCode") === null) {
				var obj = { 'html': '<!-- HTML Here -->\n', 'css': '/* CSS Here */\n' };
				var renderCode = localStorage.setItem('renderCode',JSON.stringify(obj));
				var getRenderCode = JSON.parse(localStorage.getItem('renderCode'));
			}
			var getRenderCode = JSON.parse(localStorage.getItem('renderCode'));
			editor.setValue(getRenderCode.html);
			editorCSS.setValue(getRenderCode.css);
			function fetchHTML()
			{
				return html = editor.getValue();
			}
			function fetchCSS()
			{
				return css = editorCSS.getValue();
			}
			addLinkStyleSetting();
			previewAndUpdate(isSaveAlert = false);
			editor.on('keyup',function(){
				previewAndUpdate(isSaveAlert = true)
			})
			editorCSS.on('keyup',function(){
				previewAndUpdate(isSaveAlert = true)
			})
			function addLinkStyleSetting() {
				if(localStorage.getItem("setAttrStyle") === null) {
					localStorage.setItem('setAttrStyle',JSON.stringify({'hrefs':'https://mqp99.github.io/mlib/sass/mlib.min.css'}));
					var getAttrStyle = JSON.parse(localStorage.getItem('setAttrStyle'));
				}
				var getAttrStyle = JSON.parse(localStorage.getItem('setAttrStyle'));
				$.each(getAttrStyle.hrefs.split(','), function(index, item) {
					appendLink(item);
				});
			}
			function appendLink(item){
				var _html = `
						<div class="form-group">
							<input type="text" class="form-input focus-green form-sm" value="${item}" readonly disabled>
							<span class="fal fa-minus-octagon remove-attr-link" data-href="${item}"></span>
						</div>`;
				$('.renderLink').append(_html);
			}
			function previewAndUpdate(isSaveAlert){
				var target = $('#liveUpdate')[0].contentWindow.document;
				target.open();
				target.close();
				var html = fetchHTML();
				var css = fetchCSS();
				setTimeout(()=>{
					$('body', target).html(html);
					$('head', target).append(`<style>${css}</style>`);
					var getAttrStyle = JSON.parse(localStorage.getItem('setAttrStyle'));
					for(var k in getAttrStyle.hrefs.split(',')) {
						$('head', target).append(`<link rel="stylesheet" href='${getAttrStyle.hrefs.split(',')[k]}'>`);
					}
				},500);
				if(isSaveAlert == true) {
					setTimeout(()=>{
						var obj = {
							'html': html,
							'css': css
						};
						localStorage.setItem('renderCode',JSON.stringify(obj));
						//localStorage.setItem('html',html);
						$('.auto-save').html('Đang lưu...').addClass('active');
						setTimeout(()=>{ $('.auto-save').html('Đã lưu') },500);
						setTimeout(()=>{ $('.auto-save').removeClass('active'); },3000);
					},2000);
				}
			}
		})
	</script>
</body>
</html>